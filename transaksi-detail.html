<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Transaksi Detail</title>

    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="./assets/img/favicons/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="./assets/img/favicons/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="./assets/img/favicons/favicon-16x16.png" />
    <link rel="manifest" href="./assets/img/favicons/site.webmanifest" />

    <!-- Stylesheets -->
    <link rel="stylesheet" href="./assets/css/main.css" />
  </head>
  <style>
    .page-detail-transaksi {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: row;
      background-color: var(--background);
    }

    .left-sidebar {
      width: 20rem;
      height: 100%;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      border-right: 0.2rem solid var(--primary);
    }

    .main {
      width: calc(100% - 20rem);
      height: 100%;
      padding: 1rem;
    }

    .product-item {
      background-color: white;
      border: 0.2rem solid var(--primary);
      border-radius: 0.4rem;
      width: 100%;
      padding: 1rem;
      cursor: pointer;
      transition: 0.2s;
      margin-bottom: 1rem;
    }

    .product-item:hover {
      background-color: var(--primary);
      color: var(--white) !important;
    }

    .product-item:hover .text-secondary,
    .product-item:hover .text-primary {
      color: var(--white) !important;
    }

    .btn-transaksi-detail-lunas,
    .btn-transaksi-detail-utang {
      display: none;
    }
  </style>
  <body>
    <div class="page-detail-transaksi">
      <div class="left-sidebar">
        <a href="index.html" style="width: 100%; margin-bottom: 4rem; text-align: center">
          <img src="./assets/img/logo.png" alt="" width="125" height="40" />
        </a>

        <div>
          <a href="kasir.html" class="btn btn-outline-primary btn-block" style="margin-bottom: 1rem">Kasir</a>
          <a href="produk.html" class="btn btn-outline-primary btn-block" style="margin-bottom: 1rem">Daftar Produk</a>
          <a href="transaksi.html" class="btn btn-primary btn-block">Riwayat Transaksi</a>
        </div>

        <a href="crud.php?cmd=logout" type="button" class="btn btn-danger btn-block" style="margin-top: auto">Logout</a>
      </div>
      <div class="main">
        <h1 style="margin-bottom: 4rem" id="page-detail-transaksi-title">Detail Transaksi</h1>
        <div style="display: flex">
          <div>
            <h2>Daftar Produk</h2>
            <h4 class="text-secondary" id="page-detail-transaksi-tgl"></h4>
          </div>
          <div style="margin-left: auto; margin-right: 1rem">
            <button class="btn btn-success btn-transaksi-detail-lunas" style="float: right" id="btn-transaksi-detail-lunas">Lunas</button>
            <button class="btn btn-danger btn-transaksi-detail-utang" style="float: right" id="btn-transaksi-detail-utang">Utang</button>
          </div>
          <div>
            <h4>Metode Pembayaran: <span class="text-primary">Utang</span></h4>
            <h4>Total Harus Dibayar: <span class="text-primary" id="transaksi-detail-total-harus-dibayar"></span></h4>
            <h4 style="margin-bottom: 1rem">Total Sudah Dibayar: <span class="text-primary" id="transaksi-detail-total-sudah-dibayar"></span></h4>
          </div>
        </div>
        <div class="product-list" id="product-list"></div>
      </div>
    </div>

    <script src="./assets/js/main.js"></script>
    <script>
      var tglTranksi = document.getElementById("tgl_transaksi");
      var productList = document.getElementById("product-list");
      var metodePembayaran = document.getElementById("metode_pembayaran");
      var pageDetailTransaksiTitle = document.getElementById("page-detail-transaksi-title");
      var pageDetailTransaksiTgl = document.getElementById("page-detail-transaksi-tgl");
      var btnTransaksiDetailLunas = document.getElementById("btn-transaksi-detail-lunas");
      var btnTransaksiDetailUtang = document.getElementById("btn-transaksi-detail-utang");
      var transaksiDetailTotalHarusDibayar = document.getElementById("transaksi-detail-total-harus-dibayar");
      var transaksiDetailTotalSudahDibayar = document.getElementById("transaksi-detail-total-sudah-dibayar");

      window.onload = function () {
        checkAuth();
        detailTransaksi();
        // loadProdukDiTransaksi();
      };

      function checkAuth() {
        fetch("crud.php?cmd=checkAuth")
          .then((response) => response.json())
          .then((data) => {
            if (data.result !== true) {
              // Kalau pengguna tidak login dengan benar

              alert("Maaf, Anda harus login terlebih dahulu.");
              location.href = "index.html";
            }
          });
      }

      function detailTransaksi() {
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const transactionId = urlParams.get("id");

        fetch(`crud.php?cmd=detailTransaction&id=${transactionId}`)
          .then((response) => response.json())
          .then((data) => {
            var produkHtml = "";

            document.title = `Transaksi Detail ID ${transactionId}`;
            pageDetailTransaksiTitle.innerHTML = `Detail Transaksi ID ${transactionId}`;
            pageDetailTransaksiTgl.innerHTML = data.transaction[0].tgl_waktu;
            transaksiDetailTotalHarusDibayar.innerHTML = formatAngkaKeRupiah(data.transaction[0].total_harus_dibayar);
            transaksiDetailTotalSudahDibayar.innerHTML = formatAngkaKeRupiah(data.transaction[0].total_sudah_dibayar);

            if (data.transaction[0].metode_pembayaran === "Lunas") {
              btnTransaksiDetailLunas.style.display = "block";
              btnTransaksiDetailUtang.style.display = "none";
            } else {
              btnTransaksiDetailLunas.style.display = "none";
              btnTransaksiDetailUtang.style.display = "block";
            }

            data.transaction.forEach(function (transaction) {
              produkHtml += `<div class="product-item"><div><h4>${transaction.nama}</h4><h4><span class="text-secondary">${formatAngkaKeRupiah(
                transaction.harga
              )}</span> / ${transaction.satuan}</h4><h4>Jumlah: ${formatAngkaTitik(
                transaction.jumlah
              )}</h4><h4>Total Harga: <span class="text-primary">${formatAngkaKeRupiah(transaction.total)}</span></h4></div><div></div></div>`;
            });

            productList.innerHTML = produkHtml;
          });
      }
    </script>
  </body>
</html>
