<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Transaksi Detail</title>

    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="./assets/img/favicons/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="./assets/img/favicons/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="./assets/img/favicons/favicon-16x16.png" />
    <link rel="manifest" href="./assets/img/favicons/site.webmanifest" />

    <!-- Stylesheets -->
    <link rel="stylesheet" href="./assets/css/datatables.min.css" />
    <link rel="stylesheet" href="./assets/css/jquery-ui.min.css" />
    <link rel="stylesheet" href="./assets/css/main.css" />
  </head>
  <body>
    <div class="page">
      <div class="left-sidebar">
        <a href="index.html" style="width: 100%; margin-bottom: 4rem; text-align: center">
          <img src="./assets/img/logo.png" alt="" width="125" height="40" />
        </a>

        <div>
          <a href="kasir.html" class="btn btn-outline-primary btn-block" style="margin-bottom: 1rem">Kasir</a>
          <a href="produk.html" class="btn btn-outline-primary btn-block" style="margin-bottom: 1rem">Daftar Produk</a>
          <a href="transaksi.html" class="btn btn-primary btn-block">Riwayat Transaksi</a>
        </div>

        <a href="crud.php?cmd=logout" type="button" class="btn btn-danger btn-block" style="margin-top: auto">Logout</a>
      </div>
      <div class="main">
        <h1 id="page-detail-transaksi-title">Detail Transaksi</h1>
        <h4 class="text-secondary" id="page-detail-transaksi-tgl" style="margin-bottom: 4rem"></h4>
        <div style="display: flex; margin-bottom: 4rem;">
          <h2 style="align-self: end;">Daftar Produk</h2>
          <div style="margin-left: auto; margin-right: 1rem">
            <button class="btn btn-success" style="float: right" id="btn-transaksi-detail-status-terbaru"></button>
          </div>
          <table>
            <tbody>
              <tr>
                <th style="text-align: left">Metode Pembayaran Sebelumnya</th>
                <th style="text-align: left">:</td>
                <th class="text-primary" id="transaksi-detail-metode-pembayaran" style="text-align: left"></th>
              </tr>
              <tr>
                <th style="text-align: left">Tanggal Lunas</th>
                <th style="text-align: left">:</td>
                <th class="text-primary" id="transaksi-detail-tgl-lunas" style="text-align: left"></th>
              </tr>
              <tr>
                <th style="text-align: left">Tanggal Direturn</th>
                <th style="text-align: left">:</td>
                <th class="text-primary" id="transaksi-detail-tgl-return" style="text-align: left"></th>
              </tr>
              <tr>
                <th style="text-align: left">Total Harus Dibayar</th>
                <th style="text-align: left">:</td>
                <th class="text-primary" id="transaksi-detail-total-harus-dibayar" style="text-align: left"></th>
              </tr>
              <tr>
                <th style="text-align: left">Total Sudah Dibayar</th>
                <th style="text-align: left">:</th>
                <th class="text-primary" id="transaksi-detail-total-sudah-dibayar" style="text-align: left"></th>
              </tr>
              <tr>
                <th style="text-align: left">Total Uang Kembalian</th>
                <th style="text-align: left">:</th>
                <th class="text-primary" id="transaksi-detail-total-uang-kembalian" style="text-align: left"></th>
              </tr>
            </tbody>
          </table>
        </div>
        <table id="table-produk" class="table">
          <thead>
            <tr>
              <th>No</th>
              <th>Nama</th>
              <th>Harga</th>
              <th>Satuan</th>
              <th>Jumlah</th>
              <th>Total Harga</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <script src="./assets/js/jquery.min.js"></script>
    <script src="./assets/js/datatables.min.js"></script>
    <script src="./assets/js/jquery-ui.min.js"></script>
    <script src="./assets/js/main.js"></script>
    <script>
      var tglTranksi = document.getElementById("tgl_transaksi");
      var tableProduk = document.getElementById("table-produk");
      var metodePembayaran = document.getElementById("metode_pembayaran");
      var pageDetailTransaksiTitle = document.getElementById("page-detail-transaksi-title");
      var pageDetailTransaksiTgl = document.getElementById("page-detail-transaksi-tgl");
      var btnTransaksiDetailStatusTerbaru = document.getElementById("btn-transaksi-detail-status-terbaru");
      var transaksiDetailMetodePembayaran = document.getElementById("transaksi-detail-metode-pembayaran");
      var transaksiDetailTglLunas = document.getElementById("transaksi-detail-tgl-lunas");
      var transaksiDetailTglReturn = document.getElementById("transaksi-detail-tgl-return");
      var transaksiDetailTotalHarusDibayar = document.getElementById("transaksi-detail-total-harus-dibayar");
      var transaksiDetailTotalSudahDibayar = document.getElementById("transaksi-detail-total-sudah-dibayar");
      var transaksiDetailTotalUangKembalian = document.getElementById("transaksi-detail-total-uang-kembalian");

      window.onload = function () {
        checkAuth();
        initDataTable("table-produk");
        detailTransaksi();
      };

      function detailTransaksi() {
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const transactionId = urlParams.get("id");

        fetch(`crud.php?cmd=detailTransaction&id=${transactionId}`)
          .then((response) => response.json())
          .then((data) => {
            var produkHtml = "";

            document.title = `Transaksi Detail ID ${transactionId}`;
            pageDetailTransaksiTitle.innerHTML = `Detail Transaksi ID ${transactionId}`;
            pageDetailTransaksiTgl.innerHTML = data.transaction[0].tgl_waktu;
            transaksiDetailMetodePembayaran.innerHTML = data.transaction[0].metode_pembayaran;
            transaksiDetailTglLunas.innerHTML = (data.transaction[0].tgl_lunas !== null) ? data.transaction[0].tgl_lunas : "-";
            transaksiDetailTglReturn.innerHTML = (data.transaction[0].tgl_return !== null) ? data.transaction[0].tgl_return : "-";
            transaksiDetailTotalHarusDibayar.innerHTML = formatAngkaKeRupiah(data.transaction[0].total_harus_dibayar);
            transaksiDetailTotalSudahDibayar.innerHTML = formatAngkaKeRupiah(data.transaction[0].total_sudah_dibayar);
            var total_uang_kembalian = formatAngkaKeRupiah(parseFloat(data.transaction[0].total_sudah_dibayar) - parseFloat(data.transaction[0].total_harus_dibayar));
            transaksiDetailTotalUangKembalian.innerHTML = (total_uang_kembalian > 0) ? total_uang_kembalian : formatAngkaKeRupiah(0); 

            if (data.transaction[0].metode_pembayaran === "Lunas") {
              if (data.transaction[0].tgl_return === null) {
                // Kalau lunas, tapi gk direturn
                btnTransaksiDetailStatusTerbaru.className = "btn btn-success";
                btnTransaksiDetailStatusTerbaru.innerHTML = "Lunas tanpa return";
              } else {
                // Kalau lunas, tapi direturn
                btnTransaksiDetailStatusTerbaru.className = "btn btn-info";
                btnTransaksiDetailStatusTerbaru.innerHTML = "Lunas tapi direturn";
              }
            } else {
              if (data.transaction[0].tgl_return === null) {
                // Kalau utang, tapi gk direturn
                btnTransaksiDetailStatusTerbaru.className = "btn btn-danger";
                btnTransaksiDetailStatusTerbaru.innerHTML = "Utang tanpa return";
              } else {
                // Kalau utang, tapi direturn
                btnTransaksiDetailStatusTerbaru.className = "btn btn-info";
                btnTransaksiDetailStatusTerbaru.innerHTML = "Utang tapi direturn";
              }
            }

            var iteration = 1;
            data.transaction.forEach(function (transaction) {
              produkHtml += `<tr><td>${iteration++}</td><td>${transaction.nama}</td><td>${formatAngkaKeRupiah(transaction.harga_sekarang)}</td><td>${
                transaction.satuan
              }</td><td>${formatAngkaTitik(transaction.jumlah)}</td><td>${formatAngkaKeRupiah(transaction.total)}</td></tr>`;
            });

            initDataTable("table-produk", false);
            tableProduk.querySelector("tbody").innerHTML = produkHtml;
            initDataTable("table-produk");
          });
      }
    </script>
  </body>
</html>
